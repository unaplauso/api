CREATE TYPE "public"."s3_bucket" AS ENUM('unaplauso-public', 'profile_banner', 'project_file');
DROP VIEW "public"."top_project";
ALTER TABLE "file" ADD COLUMN "bucket" "s3_bucket" DEFAULT 'unaplauso-public' NOT NULL;
CREATE VIEW "public"."top_project" AS (select "project"."id", "project"."title", "project"."created_at", "project"."deadline", "project"."goal", coalesce(sum("donation"."amount"), 0) as "donations", coalesce(count("project_interaction"."id"), 0) as "interactions", coalesce(("project"."goal" >= sum("donation"."amount") or "project"."deadline" >= NOW()), false) as "finished", "user"."id" as "creator_id", json_build_object('id', "user"."id", 'username', "user"."username", 'displayName', "user"."display_name", 'profilePic', case when "user"."profile_pic_file_id" is null then null else json_build_object('id', "profile_pic_file"."id", 'isNsfw', "profile_pic_file"."is_nsfw") end) as "creator", case when "project"."thumbnail_file_id" is null then null else json_build_object('id', "project_thumbnail_file"."id", 'isNsfw', "project_thumbnail_file"."is_nsfw") end as "thumbnail", coalesce(json_agg(json_build_object('id', "topic"."id", 'name', "topic"."name")) filter (where "topic"."id" is not null), '[]'::json) as "topics" from "project" left join "file" "project_thumbnail_file" on "project_thumbnail_file"."id" = "project"."thumbnail_file_id" left join "project_topic" on "project_topic"."project_id" = "project"."id" left join "topic" on "topic"."id" = "project_topic"."topic_id" inner join "user" on "user"."id" = "project"."creator_id" left join "file" "profile_pic_file" on "profile_pic_file"."id" = "user"."profile_pic_file_id" left join "project_donation" on "project_donation"."project_id" = "project"."id" left join "donation" on "donation"."id" = "project_donation"."donation_id" left join "project_interaction" on "project_interaction"."project_id" = "project"."id" group by "project"."id", "user"."id", "profile_pic_file"."id", "project_thumbnail_file"."id");